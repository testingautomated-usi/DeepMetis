# DeepMetis-MNIST

## General Information ##
This folder contains the application of DeepMetis to the handwritten digit classification problem.
This tool is developed in Python on top of the DEAP evolutionary computation framework. It has been tested on a machine featuring an i7 processor, 16 GB of RAM, an Nvidia GeForce 940MX GPU with 2GB of memory, Ubuntu 18.04 (bionic) OS and python 3.6.

Follow the steps below to set up DeepMetis and validate its general functionality.


## Step 1: Configure the environment  ##

Pull our pre-configured Docker image for DeepMetis-MNIST:

``` 
docker pull p1ndsvin/ubuntu:metisbox
```

Run it by typing in the terminal the following commands:

```
docker run -it --rm p1ndsvin/ubuntu:metisbox
```

## Step 2: Example Run ##

### Run DeepMetis ###
Use the following commands to start a run of DeepMetis-MNIST:

```
cd DeepMetis-MNIST
python3 main_launcher.py
```

This command will perform a single run of DeepMetis for the mutant obtained by applying 
'Add Weights Regularisation' operator to the MNIST model ('l1_l2' regularisation will be added to the first layer). The number of runs can be 
indicated by using parameter `-run_num`. DeepMetis runs in `1vs5` mode by default. The number of used mutant instances can be indicated using the parameter 
`-mutant_num`. For example, the following command will perform 3 runs of DeepMetis in `1vs10` mode.

```
python3 main_launcher.py -run_num=3 -mutant_num=10
```

> NOTE: `properties.py` contains the tool's configuration, i.e., you should edit this file to change its configuration. For example, if you want to run <i>DeepMetis-MNIST</i> for a shorter number of iteration than the experiments in the paper, you need to set the `NGEN` variable in `properties.py` to a value lower than `1000`

When the run ends, on the console you should see a message like the following:

```
Final solution N is: X
GAME OVER

Process finished with exit code 0
```

where X is the number of generated mutant-killing inputs.

Moreover, DeepMetis will create a folder `results_mnist_add_weights_regularisation_mutated0_MP_l1_l2_0_1` which contains: 
* the archive of solutions (`archive` folder); 
* the final report (`report_final.json`);
* the configuration's description (`config.json`).

### Evaluate the augmented test set with DeepCrime

Once DeepMetis has generated inputs for the mutant, we check whether augmentation with these inputs 
makes the mutant killed. First we run DeepCrime with the initial test set, i.e. without adding the
generated inputs.

```
cd ../deepcrime
python3 evaluate_metis.py -augment=no
```

At the end of the run you will see the output "Mutant killed: False".
We then run DeepCrime augmenting it with DeepMetis generated inputs.
 
```
python3 evaluate_metis.py
```

In this case, at the end of the run you will see the output "Mutant killed: True".

 
## Step3: Replicate the results in the paper ##

At this step we provide scripts to extract the data reported in the paper from our 
overall experimental data.
All the experimental data is available in the folder `experiments`. We have excluded only the `.npy` files
of the generated images due to their big size. 

Run the following command to generate the MNIST data from Table 3 in the paper.


```
cd ../DeepMetis-MNIST/experiment/
python3 replicate_table3.py
```

The script outputs the latex code for Table 3. This information is also stored in the file 
`summary.csv`. In addition, it generates the file `raw_data.csv` that provides information about each of 10 runs for each mutant.


Run the following command to generate the MNIST data from Table 4 in the paper.

```
python3 replicate_table4.py
```

The script outputs the latex code for Table 4. 

## Step 4: Run DeepMetis for any mutant ##

To run DeepMetis for any mutant we first need mutations generated for MNIST by the DeepCrime tool. 
These mutations can be downloaded from the artifacts provided by the authors of DeepCrime paper at the following links:

https://zenodo.org/record/4737748  
https://zenodo.org/record/4737754

The artifacts contain `h5` files that names of which correspond to one of the 20 instances of a mutation operator run with a specific parameter. 
The names have the following structure: 

`{mutation_operator}_MP_{parameter_value}_{instance_num}.h5`


For example, `mnist_add_noise_mutated0_MP_25.0_0.h5` corresponds to the first instance of the mutant generated by applying "Add Noise" operator to the 25% 
of the training data. As noted before, each mutant has 20 instances. 

In our replication package we provide models for only one mutant (`mnist_add_weights_regularisation_mutated0_MP_l1_l2_0` used at Step 2) due to the large size of `h5` files.
To run DeepMetis for some other mutant, copy the `h5` files of that mutant to the folder `DeepMetis-MNIST/mutant_model`. 
The number of instances of the mutant copied into this folder correspond to the setting of the DeepMetis that you want to use,
i.e. if you copy 5 instances of the mutant then you will run DeepMetis in `1vs5` setting. Correspondingly, if you copy 10 instances then 
you will run DeepMetis in `1vs10` setting.
Once the desired number of instances have been copied, run the following command:


```
python3 main_launcher.py
```




